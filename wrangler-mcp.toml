# Pantainos Memory MCP Worker
#
# Separate worker for MCP protocol access.
# - CF Access provides identity (bypass mode - doesn't block)
# - MCP OAuth handles the protocol auth flow
# - Shares D1/Vectorize bindings with API worker
#
# IMPORTANT: Terraform (infra/) is the source of truth for production.
# This file is used for `pnpm dev` (local) and `--env dev` only.
# Production deploys go through `tofu apply` which reads dist/mcp-index.js directly.

name = "pantainos-memory-mcp"
main = "src/mcp-index.ts"
compatibility_date = "2024-12-01"
compatibility_flags = ["nodejs_compat"]

# ============================================
# Production Environment (default)
# ============================================

# D1 Database (shared with API worker)
[[d1_databases]]
binding = "DB"
database_name = "pantainos-memory"
database_id = "22be27c1-7e29-4fac-81e2-cd96ceadafa2"

# Vectorize Indexes (shared with API worker)
[[vectorize]]
binding = "MEMORY_VECTORS"
index_name = "pantainos-memory-vectors"

[[vectorize]]
binding = "INVALIDATES_VECTORS"
index_name = "pantainos-memory-invalidates"

[[vectorize]]
binding = "CONFIRMS_VECTORS"
index_name = "pantainos-memory-confirms"

# Workers AI
[ai]
binding = "AI"

# OAuth KV (for MCP authentication state)
[[kv_namespaces]]
binding = "OAUTH_KV"
id = "44a53cd6bcbd4aadae45c51d1769b204"

# Analytics Engine
[[analytics_engine_datasets]]
binding = "ANALYTICS"
dataset = "memory_mcp_prod"

# Service Binding to claude-proxy (worker-to-worker, bypasses CF Access)
[[services]]
binding = "CLAUDE_PROXY"
service = "claude-proxy"

# Configuration Variables
[vars]
REASONING_MODEL = "@cf/openai/gpt-oss-120b"
DEDUP_MODEL = "@cf/openai/gpt-oss-20b"
DEDUP_THRESHOLD = "0.85"
DEDUP_LOWER_THRESHOLD = "0.55"
DEDUP_CONFIDENCE_THRESHOLD = "0.8"
RESOLVER_TYPE = "github"
RESOLVER_GITHUB_REPO = "DigiBugCat/Cassandra-Finance"
CLASSIFICATION_CHALLENGE_ENABLED = "true"
LLM_JUDGE_URL = "https://claude-proxy.pantainos.workers.dev/v1/chat/completions"

# ============================================
# Dev Environment
# ============================================
[env.dev]
name = "pantainos-memory-mcp-dev"

[env.dev.ai]
binding = "AI"

[[env.dev.services]]
binding = "CLAUDE_PROXY"
service = "claude-proxy-dev"

[env.dev.vars]
REASONING_MODEL = "@cf/openai/gpt-oss-120b"
DEDUP_MODEL = "@cf/openai/gpt-oss-20b"
DEDUP_THRESHOLD = "0.85"
DEDUP_LOWER_THRESHOLD = "0.55"
DEDUP_CONFIDENCE_THRESHOLD = "0.8"
RESOLVER_TYPE = "github"
RESOLVER_GITHUB_REPO = "DigiBugCat/Cassandra-Finance"
CLASSIFICATION_CHALLENGE_ENABLED = "true"
LLM_JUDGE_URL = "https://claude-proxy-dev.pantainos.workers.dev/v1/chat/completions"
MIN_SIMILARITY = "0.35"
VIOLATION_CONFIDENCE_THRESHOLD = "0.6"
CONFIRM_CONFIDENCE_THRESHOLD = "0.7"
MAX_CANDIDATES = "30"

# D1 Database (shared with API worker)
[[env.dev.d1_databases]]
binding = "DB"
database_name = "pantainos-memory-dev"
database_id = "cddfba98-685d-4139-933d-1160a00427c2"

# Vectorize Indexes (shared with API worker)
[[env.dev.vectorize]]
binding = "MEMORY_VECTORS"
index_name = "pantainos-memory-dev-vectors"

[[env.dev.vectorize]]
binding = "INVALIDATES_VECTORS"
index_name = "pantainos-memory-dev-invalidates"

[[env.dev.vectorize]]
binding = "CONFIRMS_VECTORS"
index_name = "pantainos-memory-dev-confirms"

# OAuth KV (shared with API worker)
[[env.dev.kv_namespaces]]
binding = "OAUTH_KV"
id = "8945fd577d87400c8f14dcfbd354aa88"

# Analytics Engine
[[env.dev.analytics_engine_datasets]]
binding = "ANALYTICS"
dataset = "memory_mcp_dev"

# Local dev server
[dev]
port = 8795
local_protocol = "http"
