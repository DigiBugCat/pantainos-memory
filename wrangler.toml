# Pantainos Memory - Zettelkasten Knowledge Graph
#
# Authentication: MCP OAuth 2.0 backed by Cloudflare Access
# Configure CF_ACCESS_TEAM and CF_ACCESS_AUD for your Zero Trust application.
#
# Environments:
#   Local:      pnpm dev (uses dev resources with --remote flag)
#   Dev:        wrangler deploy --env dev
#   Production: wrangler deploy

name = "memory"
main = "src/index.ts"
compatibility_date = "2024-12-01"
compatibility_flags = ["nodejs_compat"]

# ============================================
# Production Environment (default)
# ============================================

# Scheduled Jobs (Cron Triggers)
[triggers]
crons = ["* * * * *", "0 3 * * *"]

# D1 Database
[[d1_databases]]
binding = "DB"
database_name = "memory"
database_id = "TODO"
migrations_dir = "migrations"

# Vectorize Indexes (768 dimensions, embeddinggemma-300m)
[[vectorize]]
binding = "MEMORY_VECTORS"
index_name = "memory-vectors"

[[vectorize]]
binding = "INVALIDATES_VECTORS"
index_name = "memory-invalidates"

[[vectorize]]
binding = "CONFIRMS_VECTORS"
index_name = "memory-confirms"

# Workers AI
[ai]
binding = "AI"

# Analytics Engine
[[analytics_engine_datasets]]
binding = "ANALYTICS"
dataset = "memory_prod"

# OAuth KV (for MCP authentication state)
[[kv_namespaces]]
binding = "OAUTH_KV"
id = "TODO"

# Detection Queue
[[queues.producers]]
queue = "memory-detection"
binding = "DETECTION_QUEUE"

[[queues.consumers]]
queue = "memory-detection"
max_batch_size = 10
max_batch_timeout = 5

# Service Binding to claude-proxy (worker-to-worker, bypasses CF Access)
[[services]]
binding = "CLAUDE_PROXY"
service = "claude-proxy"

# Configuration Variables
[vars]
REASONING_MODEL = "@cf/openai/gpt-oss-120b"
DEDUP_MODEL = "@cf/openai/gpt-oss-20b"
DEDUP_THRESHOLD = "0.85"
DEDUP_LOWER_THRESHOLD = "0.70"
DEDUP_CONFIDENCE_THRESHOLD = "0.8"
RESOLVER_TYPE = "none"
CLASSIFICATION_CHALLENGE_ENABLED = "true"
LLM_JUDGE_URL = "https://claude-proxy.pantainos.workers.dev/v1/chat/completions"

# ============================================
# Dev Environment
# ============================================
[env.dev]
name = "memory-dev"

[env.dev.ai]
binding = "AI"

[[env.dev.services]]
binding = "CLAUDE_PROXY"
service = "claude-proxy-dev"

[env.dev.vars]
REASONING_MODEL = "@cf/openai/gpt-oss-120b"
DEDUP_MODEL = "@cf/openai/gpt-oss-20b"
DEDUP_THRESHOLD = "0.85"
DEDUP_LOWER_THRESHOLD = "0.70"
DEDUP_CONFIDENCE_THRESHOLD = "0.8"
RESOLVER_TYPE = "none"
CLASSIFICATION_CHALLENGE_ENABLED = "true"
LLM_JUDGE_URL = "https://claude-proxy-dev.pantainos.workers.dev/v1/chat/completions"
# Exposure check thresholds (lower = more sensitive)
MIN_SIMILARITY = "0.35"
VIOLATION_CONFIDENCE_THRESHOLD = "0.6"
CONFIRM_CONFIDENCE_THRESHOLD = "0.7"
MAX_CANDIDATES = "30"

[[env.dev.d1_databases]]
binding = "DB"
database_name = "memory-dev"
database_id = "cddfba98-685d-4139-933d-1160a00427c2"
migrations_dir = "migrations"

[[env.dev.vectorize]]
binding = "MEMORY_VECTORS"
index_name = "memory-dev-vectors"

[[env.dev.vectorize]]
binding = "INVALIDATES_VECTORS"
index_name = "memory-dev-invalidates"

[[env.dev.vectorize]]
binding = "CONFIRMS_VECTORS"
index_name = "memory-dev-confirms"

[[env.dev.queues.producers]]
queue = "memory-dev-detection"
binding = "DETECTION_QUEUE"

[[env.dev.queues.consumers]]
queue = "memory-dev-detection"
max_batch_size = 10
max_batch_timeout = 5

[[env.dev.analytics_engine_datasets]]
binding = "ANALYTICS"
dataset = "memory_dev"

# OAuth KV (for MCP authentication state)
[[env.dev.kv_namespaces]]
binding = "OAUTH_KV"
id = "8945fd577d87400c8f14dcfbd354aa88"

# Local dev server
[dev]
port = 8794
local_protocol = "http"
